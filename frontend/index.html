<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seyahat AsistanÄ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">



</head>

<body>
    <div class="app-container">
        <div class="chat-container">
            <div class="chat-header">
                <h1>Seyahat AsistanÄ± âœˆï¸</h1>
                <p>Hava durumu ve otel bilgisi iÃ§in benimle sohbet edin</p>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message">
                    <h2>Merhaba! ğŸ‘‹</h2>
                    <p>Size nasÄ±l yardÄ±mcÄ± olabilirim?</p>
                    <div class="suggestion-chips">
                        <div class="chip" onclick="sendMessage('Ä°stanbul\'da 4 yÄ±ldÄ±zlÄ± otel ara')">Ä°stanbul otelleri
                        </div>
                        <div class="chip" onclick="sendMessage('Paris\'te otel bul')">Paris otelleri</div>
                        <div class="chip" onclick="sendMessage('Ankara hava durumu')">Hava durumu</div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="userInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."
                        onkeypress="handleKeyPress(event)">
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        â¤
                    </button>
                </div>
            </div>
        </div>

        <div class="results-panel" id="resultsPanel">
            <div class="results-header">
                <h2>ğŸ“‹ SonuÃ§lar</h2>
            </div>
            <div class="results-content" id="resultsContent">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ”</div>
                    <p>Otel veya hava durumu aramasÄ± yapÄ±n, sonuÃ§lar burada gÃ¶rÃ¼necek.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const resultsContent = document.getElementById('resultsContent');

        let ws = null;

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8002/ws');

            ws.onopen = function () {
                console.log('WebSocket baÄŸlantÄ±sÄ± kuruldu');
            };

            ws.onmessage = function (event) {
                removeTypingIndicator();
                const data = JSON.parse(event.data);
                console.log('Received WebSocket message:', data);

                if (data.type === 'message') {
                    addMessage(data.content, 'assistant');
                } else if (data.type === 'weather') {
                    addWeatherToPanel(data.data);
                    addMessage('Hava durumu bilgisi saÄŸ panelde gÃ¶rÃ¼ntÃ¼leniyor.', 'assistant');
                } else if (data.type === 'hotels') {
                    console.log('Hotel data received:', data.data);
                    addHotelsToPanel(data.data);
                    addMessage('Otel sonuÃ§larÄ± saÄŸ panelde gÃ¶rÃ¼ntÃ¼leniyor.', 'assistant');
                } else if (data.type === 'flights') {
                    console.log('Flight data received:', data.data);
                    addFlightsToPanel(data.data);
                    addMessage('UÃ§uÅŸ sonuÃ§larÄ± saÄŸ panelde gÃ¶rÃ¼ntÃ¼leniyor.', 'assistant');
                } else if (data.type === 'error') {
                    addMessage(data.content, 'assistant');
                }
            };

            ws.onerror = function (error) {
                console.error('WebSocket hatasÄ±:', error);
                removeTypingIndicator();
                addMessage('BaÄŸlantÄ± hatasÄ±. LÃ¼tfen tekrar deneyin.', 'assistant');
            };

            ws.onclose = function () {
                console.log('WebSocket baÄŸlantÄ±sÄ± kapandÄ±');
                setTimeout(connectWebSocket, 3000);
            };
        }

        connectWebSocket();

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage(predefinedMessage) {
            const message = predefinedMessage || userInput.value.trim();

            if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;

            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            addMessage(message, 'user');
            userInput.value = '';

            showTypingIndicator();

            ws.send(JSON.stringify({
                message: message
            }));
        }

        // Markdown'Ä± HTML'e Ã§eviren basit parser
        function parseMarkdown(text) {
            // Ã–nce HTML karakterlerini escape et
            text = text.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Bold **text**
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Italic *text*
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Bullet points - multi-line
            text = text.replace(/^[â€¢\-\*]\s+(.+)$/gm, '<li>$1</li>');

            // Wrap consecutive list items in ul
            text = text.replace(/(<li>.*<\/li>\s*)+/gs, function (match) {
                return '<ul style="margin: 8px 0; padding-left: 20px;">' + match + '</ul>';
            });

            // Line breaks
            text = text.replace(/\n/g, '<br>');

            // Numbered lists
            text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<li>$2</li>');

            // Headers (Ã¶rn: ## BaÅŸlÄ±k)
            text = text.replace(/^##\s+(.+)$/gm, '<h3 style="margin: 8px 0; font-size: 16px;">$1</h3>');

            return text;
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            // Assistant mesajlarÄ± iÃ§in markdown dÃ¶nÃ¼ÅŸÃ¼mÃ¼ yap
            const content = sender === 'assistant' ? parseMarkdown(text) : text;

            if (sender === 'assistant') {
                messageDiv.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">${content}</div>
            `;
            } else {
                messageDiv.innerHTML = `
                <div class="message-content">${text}</div>
                <div class="message-avatar">ğŸ‘¤</div>
            `;
            }

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addWeatherCard(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';

            messageDiv.innerHTML = `
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
                <div class="weather-card">
                    <div class="city">${data.city}</div>
                    <div class="temp">${Math.round(data.temperature)}Â°C</div>
                    <div class="description">${data.description}</div>
                    <div class="details">
                        <span>Hissedilen: ${Math.round(data.feels_like)}Â°C</span>
                        <span>Nem: ${data.humidity}%</span>
                    </div>
                </div>
            </div>
        `;

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addHotelCards(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';

            const currencySymbol = data.currency_symbol || '$';

            let hotelsHtml = `<div class="hotels-container">`;
            hotelsHtml += `<div class="hotels-header">${data.location} iÃ§in bulunan oteller</div>`;

            if (data.hotels && data.hotels.length > 0) {
                hotelsHtml += `<div class="hotels-grid">`;

                data.hotels.forEach((hotel, index) => {
                    hotelsHtml += `
                        <div class="hotel-card">
                            <div class="hotel-image-placeholder"></div>
                            <div class="hotel-card-content">
                                <div class="hotel-name">${hotel.name || 'Ä°simsiz Otel'}</div>
                                
                                ${hotel.overall_rating ? `
                                    <div class="hotel-rating">
                                        <span class="hotel-stars">â­ ${hotel.overall_rating}</span>
                                        ${hotel.reviews ? `<span class="hotel-reviews">(${hotel.reviews} deÄŸerlendirme)</span>` : ''}
                                    </div>
                                ` : ''}
                                
                                ${hotel.hotel_class ? `
                                    <div class="hotel-class">${hotel.hotel_class}</div>
                                ` : ''}
                                
                                ${hotel.rate_per_night || hotel.total_rate ? `
                                    <div class="hotel-price">${currencySymbol}${hotel.rate_per_night || hotel.total_rate}</div>
                                    <div class="hotel-price-label">gecelik</div>
                                ` : ''}
                                
                                ${hotel.amenities && hotel.amenities.length > 0 ? `
                                    <div class="hotel-amenities">
                                        ${hotel.amenities.slice(0, 4).map(amenity => `
                                            <span class="amenity-tag">${amenity}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                ${hotel.latitude && hotel.longitude ? `
                                    <a href="https://www.google.com/maps/search/?api=1&query=${hotel.latitude},${hotel.longitude}" target="_blank" class="map-button">
                                        ğŸ“ Haritada GÃ¶r
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                hotelsHtml += `</div>`;
            } else {
                hotelsHtml += `<p style="color: #6b7280; text-align: center; padding: 20px;">ÃœzgÃ¼nÃ¼m, otel bulunamadÄ±.</p>`;
            }

            hotelsHtml += `</div>`;

            messageDiv.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content" style="max-width: 100%;">
                    ${hotelsHtml}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // YENÄ° FONKSÄ°YONLAR - SonuÃ§larÄ± saÄŸ panelde gÃ¶ster
        function addWeatherToPanel(data) {
            // Sadece empty state'i temizle, diÄŸer sonuÃ§larÄ± koru
            const emptyState = resultsContent.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Results panel'i gÃ¶ster
            const resultsPanel = document.getElementById('resultsPanel');
            resultsPanel.classList.add('visible');

            // Eski weather container'Ä± kaldÄ±r
            const oldWeather = resultsContent.querySelector('.weather-container');
            if (oldWeather) {
                oldWeather.remove();
            }

            // Yeni yapÄ±: forecasts array'i var
            const forecasts = data.forecasts || [];
            const firstForecast = forecasts[0] || {};
            const weatherType = firstForecast.weather_type || 'default';

            let weatherHtml = `<div class="weather-container" style="margin-bottom: 16px;">`;

            // Ana hava durumu kartÄ±
            weatherHtml += `
                <div class="weather-card ${weatherType}">
                    <div class="city">ğŸ“ ${data.city}</div>
                    <div class="temp">${firstForecast.temperature || 0}Â°C</div>
                    <div class="description">${firstForecast.description || ''}</div>
                    <div class="details">
                        <span>ğŸ“… ${firstForecast.day_name || ''}, ${firstForecast.date || ''}</span>
            `;

            if (firstForecast.feels_like !== undefined) {
                weatherHtml += `<span>ğŸŒ¡ï¸ Hissedilen: ${firstForecast.feels_like}Â°C</span>`;
            }
            if (firstForecast.humidity !== undefined) {
                weatherHtml += `<span>ğŸ’§ Nem: ${firstForecast.humidity}%</span>`;
            }

            weatherHtml += `</div></div>`;

            // Ã‡oklu gÃ¼n tahmini varsa grid gÃ¶ster
            if (forecasts.length > 1) {
                weatherHtml += `<div class="weather-forecast-grid">`;

                forecasts.forEach((forecast, index) => {
                    if (index === 0) return; // Ä°lk gÃ¼nÃ¼ zaten gÃ¶sterdik

                    const fType = forecast.weather_type || 'default';
                    weatherHtml += `
                        <div class="weather-forecast-card ${fType}">
                            <div class="forecast-day">${forecast.day_name || ''}</div>
                            <div class="forecast-date">${forecast.date || ''}</div>
                            <div class="forecast-temp">${forecast.temperature || 0}Â°C</div>
                            <div class="forecast-desc">${forecast.description || ''}</div>
                            <div class="forecast-details">
                                ğŸ’§ ${forecast.humidity || 0}%
                            </div>
                        </div>
                    `;
                });

                weatherHtml += `</div>`;
            }

            weatherHtml += `</div>`;

            // Append et
            const weatherContainer = document.createElement('div');
            weatherContainer.innerHTML = weatherHtml;
            resultsContent.insertBefore(weatherContainer.firstChild, resultsContent.firstChild);
        }

        function addHotelsToPanel(data) {
            // Sadece empty state'i temizle, diÄŸer sonuÃ§larÄ± koru
            const emptyState = resultsContent.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Results panel'i gÃ¶ster
            const resultsPanel = document.getElementById('resultsPanel');
            resultsPanel.classList.add('visible');

            // Eski hotel sonuÃ§larÄ±nÄ± kaldÄ±r (yeni sonuÃ§lar eklenecek)
            const oldHotels = resultsContent.querySelector('.hotels-container');
            if (oldHotels) {
                oldHotels.remove();
            }

            const currencySymbol = data.currency_symbol || '$';

            let hotelsHtml = `<div class="hotels-container">`;
            hotelsHtml += `<div class="hotels-header">${data.location} iÃ§in bulunan oteller</div>`;

            if (data.hotels && data.hotels.length > 0) {
                hotelsHtml += `<div class="hotels-grid">`;

                data.hotels.forEach((hotel, index) => {
                    hotelsHtml += `
                        <div class="hotel-card">
                            <div class="hotel-image-placeholder"></div>
                            <div class="hotel-card-content">
                                <div class="hotel-name">${hotel.name || 'Ä°simsiz Otel'}</div>
                                
                                ${hotel.overall_rating ? `
                                    <div class="hotel-rating">
                                        <span class="hotel-stars">â­ ${hotel.overall_rating}</span>
                                        ${hotel.reviews ? `<span class="hotel-reviews">(${hotel.reviews} deÄŸerlendirme)</span>` : ''}
                                    </div>
                                ` : ''}
                                
                                ${hotel.hotel_class ? `
                                    <div class="hotel-class">${hotel.hotel_class}</div>
                                ` : ''}
                                
                                ${hotel.rate_per_night || hotel.total_rate ? `
                                    <div class="hotel-price">${currencySymbol}${hotel.rate_per_night || hotel.total_rate}</div>
                                    <div class="hotel-price-label">gecelik</div>
                                ` : ''}
                                
                                ${hotel.amenities && hotel.amenities.length > 0 ? `
                                    <div class="hotel-amenities">
                                        ${hotel.amenities.slice(0, 4).map(amenity => `
                                            <span class="amenity-tag">${amenity}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                ${hotel.latitude && hotel.longitude ? `
                                    <a href="https://www.google.com/maps/search/?api=1&query=${hotel.latitude},${hotel.longitude}" target="_blank" class="map-button">
                                        ğŸ“ Haritada GÃ¶r
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                hotelsHtml += `</div>`;
            } else {
                hotelsHtml += `<p style="color: #6b7280; text-align: center; padding: 20px;">ÃœzgÃ¼nÃ¼m, otel bulunamadÄ±.</p>`;
            }

            hotelsHtml += `</div>`;

            // Append etmek yerine yeni div oluÅŸtur
            const hotelsContainer = document.createElement('div');
            hotelsContainer.innerHTML = hotelsHtml;
            resultsContent.appendChild(hotelsContainer.firstChild);
        }

        function addFlightsToPanel(data) {
            // Sadece empty state'i temizle
            const emptyState = resultsContent.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Results panel'i gÃ¶ster
            const resultsPanel = document.getElementById('resultsPanel');
            resultsPanel.classList.add('visible');

            // Eski flight sonuÃ§larÄ±nÄ± kaldÄ±r
            const oldFlights = resultsContent.querySelector('.flights-container');
            if (oldFlights) {
                oldFlights.remove();
            }

            const currencySymbol = data.currency_symbol || 'â‚º';

            let flightsHtml = `<div class="flights-container">`;
            flightsHtml += `<div class="flights-header">âœˆï¸ ${data.departure} â†’ ${data.arrival}</div>`;
            flightsHtml += `<div class="flight-date">ğŸ“… ${data.outbound_date}${data.return_date ? ' - ' + data.return_date : ' (Tek yÃ¶n)'}</div>`;
            flightsHtml += `<div class="price-disclaimer">âš ï¸ Fiyatlar anlÄ±k deÄŸiÅŸebilir. GÃ¼ncel fiyat iÃ§in tÄ±klayÄ±n.</div>`;

            if (data.flights && data.flights.length > 0) {
                flightsHtml += `<div class="flights-list">`;

                data.flights.forEach((flight, index) => {
                    const totalDuration = flight.total_duration ? `${Math.floor(flight.total_duration / 60)}s ${flight.total_duration % 60}dk` : '';

                    flightsHtml += `
                        <div class="flight-card">
                            <div class="flight-card-header">
                                <div class="flight-price">${currencySymbol}${flight.price || 'N/A'}</div>
                                ${totalDuration ? `<div class="flight-duration">â±ï¸ ${totalDuration}</div>` : ''}
                            </div>
                            <div class="flight-segments">
                    `;

                    // Her segment iÃ§in
                    flight.flights.forEach((segment, segIndex) => {
                        flightsHtml += `
                            <div class="flight-segment">
                                <div class="segment-airline">
                                    ${segment.airline_logo ? `<img src="${segment.airline_logo}" alt="${segment.airline}" class="airline-logo">` : ''}
                                    <span class="airline-name">${segment.airline || 'Havayolu'}</span>
                                    <span class="flight-number">${segment.flight_number || ''}</span>
                                </div>
                                <div class="segment-route">
                                    <div class="segment-departure">
                                        <div class="segment-time">${segment.departure_time || ''}</div>
                                        <div class="segment-airport">${segment.departure_code || ''}</div>
                                    </div>
                                    <div class="segment-arrow">
                                        <div class="segment-duration">${segment.duration ? Math.floor(segment.duration / 60) + 's ' + (segment.duration % 60) + 'dk' : ''}</div>
                                        <div class="arrow-line"></div>
                                    </div>
                                    <div class="segment-arrival">
                                        <div class="segment-time">${segment.arrival_time || ''}</div>
                                        <div class="segment-airport">${segment.arrival_code || ''}</div>
                                    </div>
                                </div>
                                ${segment.travel_class ? `<div class="segment-class">${segment.travel_class}</div>` : ''}
                            </div>
                        `;

                        // Segment aralarÄ±na aktarma gÃ¶stergesi
                        if (segIndex < flight.flights.length - 1) {
                            flightsHtml += `<div class="layover-indicator">ğŸ”„ Aktarma</div>`;
                        }
                    });

                    // Booking URL: Ã¶nce uÃ§uÅŸun kendi URL'i, yoksa genel arama
                    const bookingUrl = flight.booking_url || data.google_flights_url;

                    flightsHtml += `
                            </div>
                            <div class="flight-card-footer">
                                <a href="${bookingUrl}" target="_blank" class="ticket-button">
                                    ğŸ« Bilet Al
                                </a>
                            </div>
                        </div>
                    `;
                });

                flightsHtml += `</div>`;
            } else {
                flightsHtml += `<p style="color: #6b7280; text-align: center; padding: 20px;">ÃœzgÃ¼nÃ¼m, uÃ§uÅŸ bulunamadÄ±.</p>`;
            }

            flightsHtml += `</div>`;

            const flightsContainer = document.createElement('div');
            flightsContainer.innerHTML = flightsHtml;
            resultsContent.appendChild(flightsContainer.firstChild);
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
            <div class="message-avatar">ğŸ¤–</div>
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>

</html>